version: 2.1
orbs:
  aws-cli: circleci/aws-cli@0.1.13
jobs:
  build:
    docker:
      - image: amazonlinux:latest
    # working_directory: /tmp/my-project
    steps:
      - add_ssh_keys:
          fingerprints:
            - "b8:13:c3:67:7d:35:f1:c1:6c:e4:9d:d6:48:33:4a:34"
      - run:
          name: Install git
          command: yum install -y git
      - checkout
      - run:
          name: Install rustup
          command: |
            # TODO: don't reinstall rustup if it's not necessary, it will
            # invalidate all the cache.
            yum install -y wget tar
            if [ ! -d /root/.rustup ]
            then
              echo "Installing rustup"
              curl -f -L https://static.rust-lang.org/rustup.sh -O
              chmod 755 rustup.sh
              ./rustup.sh -y
              ~/.cargo/bin/rustup default stable
            else
              echo "rustup already installed"
            fi
      - restore_cache:
          keys:
            - deps6-cargo-{{ checksum "Cargo.lock" }}
            - deps6-cargo
      - run:
          name: Build
          command: |
            ~/.cargo/bin/rustup default stable
            ~/.cargo/bin/cargo build --release
      - save_cache:
          key: deps6-cargo-{{ checksum "Cargo.lock" }}
          paths:
            - "target"
            - "~/.cargo"
  test:
    docker:
      - image: amazonlinux:latest
    # working_directory: /tmp/my-project
    steps:
      - add_ssh_keys:
          fingerprints:
            - "b8:13:c3:67:7d:35:f1:c1:6c:e4:9d:d6:48:33:4a:34"
      - run:
          name: Install git
          command: yum install -y git
      - checkout
      - run:
          name: Install rustup
          command: |
            # TODO: don't reinstall rustup if it's not necessary, it will
            # invalidate all the cache.
            yum install -y wget tar
            if [ ! -d /root/.rustup ]
            then
              echo "Installing rustup"
              curl -f -L https://static.rust-lang.org/rustup.sh -O
              chmod 755 rustup.sh
              ./rustup.sh -y
              ~/.cargo/bin/rustup default stable
            else
              echo "rustup already installed"
            fi
      - restore_cache:
          keys:
            - deps6-cargo-{{ checksum "Cargo.lock" }}
            - deps6-cargo
      - run:
          name: Build Server
          command: |
            ~/.cargo/bin/rustup default stable
            ~/.cargo/bin/cargo test
      - save_cache:
          key: deps6-cargo-{{ checksum "Cargo.lock" }}
          paths:
            - "target"
            - "~/.cargo"

workflows:
  version: 2
  build-test:
    jobs:
      - build
      - test
